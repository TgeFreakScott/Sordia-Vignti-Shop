<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sordia Vignti ‚Äì Shop Terminal</title>

  <style>
    :root{
      --bg:#0b0e14;
      --panel:#0f1420;
      --panel2:#0c111b;
      --border:rgba(255,255,255,.08);
      --border2:rgba(255,255,255,.12);
      --text:#f2f4ff;
      --muted:rgba(242,244,255,.68);
      --muted2:rgba(242,244,255,.48);
      --accent:#7c8cff;
      --good:#41d07a;
      --warn:#ffcc66;
      --bad:#ff5d6c;
      --shadow: 0 12px 40px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 700px at 30% -10%, rgba(124,140,255,.12), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(65,208,122,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }

    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,14,20,.92), rgba(11,14,20,.72));
      border-bottom:1px solid var(--border);
      padding:14px 16px;
    }

    .headRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    h1{margin:0;font-size:16px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12px;margin-top:4px}

    .quickShop{
      display:none;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .quickShop .tool{
      min-width: 280px;
    }

    .wrap{
      max-width:1280px;
      margin:0 auto;
      padding:14px;
      display:grid;
      grid-template-columns: 320px 1fr 360px;
      gap:12px;
      align-items:start;
    }
    @media(max-width:1100px){
      .wrap{grid-template-columns: 1fr}
    }

    /* When builder shop is active: hide left shops panel and give items more width */
    body.builder-mode .wrap{
      grid-template-columns: 1fr 360px;
    }
    body.builder-mode .shopsCard{
      display:none;
    }
    body.builder-mode .quickShop{
      display:flex;
    }

    .card{
      background: linear-gradient(180deg, rgba(15,20,32,.92), rgba(12,17,27,.92));
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card h2{
      margin:0;
      padding:12px 12px 10px;
      font-size:12px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color: rgba(207,215,255,.9);
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    /* Sidebar (shops) */
    .shopsPanel{padding:10px}
    .shopSearch{
      width:100%;
      border:1px solid var(--border);
      background: rgba(8,11,18,.6);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      outline:none;
      margin-bottom:10px;
    }
    .shopList{
      display:grid;
      gap:8px;
      //max-height: calc(100vh - 210px);
      overflow:auto;
      padding-right:4px;
    }
    .shopBtn{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 10px;
      border:1px solid var(--border);
      background: rgba(8,11,18,.55);
      border-radius:14px;
      cursor:pointer;
      transition: .12s transform ease, .12s border-color ease, .12s background ease;
    }
    .shopBtn:hover{transform: translateY(-1px); border-color: var(--border2)}
    .shopBtn.active{
      border-color: rgba(124,140,255,.65);
      background: rgba(124,140,255,.10);
      box-shadow: 0 0 0 2px rgba(124,140,255,.12) inset;
    }
    .shopIcon{
      width:34px;height:34px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      display:grid; place-items:center;
      font-size:16px;
      flex:0 0 auto;
    }
    .shopName{font-weight:800;font-size:13px;line-height:1.2}
    .shopHint{font-size:11px;color:var(--muted2);margin-top:2px}

    /* Main items header controls */
    .toolbar{
      padding:10px 12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      border-bottom:1px solid var(--border);
      background: rgba(8,11,18,.45);
      align-items:center;
    }
    .tool{
      border:1px solid var(--border);
      background: rgba(8,11,18,.6);
      color:var(--text);
      border-radius:12px;
      padding:9px 10px;
      outline:none;
    }
    .toolBtn{
      border:1px solid var(--border);
      background: rgba(8,11,18,.6);
      color:var(--text);
      border-radius:12px;
      padding:9px 10px;
      cursor:pointer;
    }
    .toolBtn.active{
      border-color: rgba(124,140,255,.65);
      background: rgba(124,140,255,.10);
    }

    /* Item list */
    .grid{padding:10px 12px; display:grid; gap:8px;}
    #items{
      //max-height: calc(100vh - 210px);
      overflow:auto;
      padding-right:6px;
    }

    .itemRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:12px;
      padding:10px 10px;
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(8,11,18,.55);
    }
    .title{
      font-weight:900;
      font-size:14px;
      letter-spacing:.1px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .meta{font-size:12px;color:var(--muted);margin-top:3px}
    .meta.small{font-size:11px;color:var(--muted2);margin-top:6px}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:11px;
      color: var(--muted);
      background: rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .badge.good{border-color: rgba(65,208,122,.35); color: rgba(65,208,122,.95)}
    .badge.warn{border-color: rgba(255,204,102,.35); color: rgba(255,204,102,.95)}
    .badge.bad{border-color: rgba(255,93,108,.35); color: rgba(255,93,108,.95)}

    .rightCol{min-width:170px; text-align:right}
    .price{
      font-weight:1000;
      font-size:14px;
      letter-spacing:.2px;
    }
    .controls{
      display:flex;
      align-items:center;
      gap:8px;
      justify-content:flex-end;
      margin-top:8px;
    }

    button{
      cursor:pointer;
      border:1px solid var(--border);
      background: rgba(10,14,22,.75);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      transition:.12s transform ease,.12s border-color ease;
    }
    button:hover{transform: translateY(-1px); border-color: var(--border2)}
    button:disabled{opacity:.45; cursor:not-allowed; transform:none}
    button.small{padding:6px 10px;border-radius:10px}
    .qty{min-width:30px;text-align:center;font-variant-numeric:tabular-nums;color:var(--text)}

    /* Cart */
    .cart{padding:10px 12px; display:grid; gap:8px}
    .sticky{
      position: sticky;
      top: 86px;
      max-height: calc(100vh - 120px);
      overflow:auto;
    }
    .cartline{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(8,11,18,.55);
    }
    .empty{color:var(--muted);font-size:12px}
    .row{display:flex;justify-content:space-between;gap:10px}
    .total{font-size:18px;font-weight:1000}
    .footerBtns{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .ok{border-color: rgba(65,208,122,.35); background: rgba(65,208,122,.10)}
    .danger{border-color: rgba(255,93,108,.35); background: rgba(255,93,108,.10)}
    .ghost{border-color: var(--border); background: transparent}

    /* ===== Builder UI ===== */
    .builderTop{
      position: sticky;
      top: 0;
      z-index: 5;
      background: linear-gradient(180deg, rgba(12,17,27,.98), rgba(12,17,27,.86));
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      margin-bottom:10px;
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
    }
    .builderTopGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:start;
    }
    @media(max-width:900px){
      .builderTopGrid{grid-template-columns: 1fr}
    }
    .builderTop .title{font-size:15px}
    .builderControls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .section{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background: rgba(8,11,18,.45);
      margin-bottom:10px;
    }
    .sectionHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      cursor:pointer;
      user-select:none;
      background: rgba(8,11,18,.65);
      border-bottom:1px solid var(--border);
    }
    .sectionHead:hover{background: rgba(8,11,18,.78)}
    .sectionTitle{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:11px;
      color: rgba(207,215,255,.9);
    }
    .caret{
      opacity:.7;
      font-size:12px;
    }
    .sectionBody{
      padding:10px;
      display:none;
    }
    .section.open .sectionBody{display:block;}

    .modGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:8px;
    }
    @media(max-width:900px){
      .modGrid{grid-template-columns: 1fr;}
    }

    .modCard{
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(8,11,18,.55);
      padding:10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
    }
    .modCard.disabled{opacity:.45}
    .modName{font-weight:900}
    .modDesc{font-size:12px;color:var(--muted);margin-top:4px;line-height:1.25}
    .tagRow{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
    .miniBtn{
      padding:7px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(10,14,22,.75);
      color: var(--text);
      cursor:pointer;
    }
    .miniBtn:hover{border-color:var(--border2)}
    .miniBtn:disabled{opacity:.5; cursor:not-allowed}
    .miniBtn.on{
      border-color: rgba(124,140,255,.65);
      background: rgba(124,140,255,.12);
    }

    .warnBox{
      border:1px solid rgba(255,204,102,.35);
      background: rgba(255,204,102,.06);
      border-radius:14px;
      padding:10px;
      margin-top:10px;
    }
    .okBox{
      border:1px solid rgba(65,208,122,.35);
      background: rgba(65,208,122,.06);
      border-radius:14px;
      padding:10px;
      margin-top:10px;
    }
	/* ===== Build Summary (bottom) ===== */
.summaryBox{
  border:1px solid var(--border);
  border-radius:16px;
  background: linear-gradient(180deg, rgba(8,11,18,.55), rgba(8,11,18,.35));
  padding:12px;
  margin-top:14px;
}
.summaryTitle{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  font-weight:1000;
  font-size:14px;
}
.summaryCols{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  margin-top:10px;
}
@media(max-width:900px){
  .summaryCols{grid-template-columns:1fr}
}
.summaryCard{
  border:1px solid var(--border);
  border-radius:14px;
  background: rgba(0,0,0,.14);
  padding:10px;
}
.summaryCard h3{
  margin:0 0 8px 0;
  font-size:11px;
  letter-spacing:.14em;
  text-transform:uppercase;
  color: rgba(207,215,255,.9);
}
.summaryLine{
  display:flex;
  justify-content:space-between;
  gap:10px;
  font-size:12px;
  color: var(--muted);
  padding:4px 0;
  border-bottom:1px solid rgba(255,255,255,.06);
}
.summaryLine:last-child{border-bottom:none}
.summaryStrong{color:var(--text);font-weight:900}
.preBlock{
  white-space:pre-wrap;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-size:12px;
  color: rgba(242,244,255,.78);
  line-height:1.35;
}
/* =========================
   MOBILE FIX (OVERRIDES)
   ========================= */

/* Make the layout stack properly on mobile */
@media (max-width: 1100px) {
  .wrap{
    grid-template-columns: 1fr !important;
    gap: 12px !important;
  }

  /* Turn off sticky behaviour on mobile */
  .sticky{
    position: static !important;
    top: auto !important;
    max-height: none !important;
    overflow: visible !important;
  }

  /* Remove height traps that cause blank panels */
  .shopList{
    max-height: none !important;
    overflow: visible !important;
  }

  /* Your ITEMS container needs to be allowed to grow + scroll naturally */
  .grid{
    padding: 10px 12px !important;
  }

  /* IMPORTANT: this was wrong in your code ‚Äî
     you put max-height/overflow on each itemRow.
     On mobile it causes madness. */
  .itemRow{
    max-height: none !important;
    overflow: visible !important;
  }

  /* Make the items panel scrollable if content is long */
  #items{
    max-height: none !important;
    overflow: visible !important;
  }

  /* Slightly tighter buttons on mobile */
  button{
    padding: 10px 10px !important;
  }
  button.small{
    padding: 6px 10px !important;
  }

  /* Inputs full width */
  .tool, .toolBtn, .shopSearch{
    width: 100% !important;
  }

  .toolbar{
    display:grid !important;
    grid-template-columns: 1fr !important;
  }
}

/* Even smaller phones */
@media (max-width: 480px) {
  .rightCol{min-width: 140px !important;}
  .controls{gap:6px !important;}
}

  </style>
</head>

<body>
<header>
  <div class="headRow">
    <div>
      <h1>üõí Sordia Vignti ‚Äì Shop Terminal</h1>
      <div class="sub">Select a shop, add items, then copy checkout text to send the DM.</div>
    </div>

    <!-- Appears ONLY in builder-mode so the left sidebar doesn't steal space -->
    <div class="quickShop">
      <select id="shopDropdown" class="tool" title="Select shop"></select>
      <span class="empty" id="quickShopHint"></span>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card shopsCard">
    <h2>Shops</h2>
    <div class="shopsPanel">
      <input id="shopSearch" class="shopSearch" placeholder="Search shops‚Ä¶" />
      <div class="shopList" id="tabs"></div>
    </div>
  </div>

  <div class="card">
    <h2>Items <span id="shopTitle" class="empty"></span></h2>

    <!-- Normal shop toolbar (hidden automatically for builder shop) -->
    <div class="toolbar" id="toolbar">
      <input id="itemSearch" class="tool" placeholder="Search items‚Ä¶" />
      <select id="categoryFilter" class="tool">
        <option value="">All categories</option>
      </select>
      <button id="sortBtn" class="toolBtn" title="Sort by price">Sort: Price ‚Üë</button>
    </div>

    <div class="grid" id="items"></div>
  </div>

  <div class="card sticky">
    <h2>Cart</h2>
    <div class="cart" id="cart"></div>
  </div>
</div>

<script>
  // ======= LOAD DATA =======
  let DATA = null;

  // Normal cart (non-builder)
  const cart = new Map();
  let activeShopId = null;
  let shopSearchTerm = "";
  let itemSearchTerm = "";
  let categoryTerm = "";
  let sortDir = 1;

  const shopSearchEl = document.getElementById("shopSearch");
  const itemSearchEl = document.getElementById("itemSearch");
  const categoryEl = document.getElementById("categoryFilter");
  const sortBtnEl = document.getElementById("sortBtn");
  const shopTitleEl = document.getElementById("shopTitle");
  const toolbarEl = document.getElementById("toolbar");
  const tabsEl = document.getElementById("tabs");
  const itemsEl = document.getElementById("items");
  const cartEl = document.getElementById("cart");

  // Builder-mode shop dropdown
  const shopDropdownEl = document.getElementById("shopDropdown");
  const quickShopHintEl = document.getElementById("quickShopHint");

  const to2 = (n) => Math.round(n * 100) / 100;

  function formatCoins(price_gp, stock = 999) {
    if ((price_gp === 0 || price_gp === "0") && Number(stock) === 0) return "Varies";
    const totalCp = Math.round(Number(price_gp) * 100);
    if (totalCp === 0) return "0 gp";
    const gp = Math.floor(totalCp / 100);
    const sp = Math.floor((totalCp % 100) / 10);
    const cp = totalCp % 10;
    const parts = [];
    if (gp) parts.push(`${gp} gp`);
    if (sp) parts.push(`${sp} sp`);
    if (cp) parts.push(`${cp} cp`);
    return parts.join(" ");
  }

  function shopById(id){ return DATA.shops.find(s => s.id === id); }

  function itemById(shopId,itemId){
    const shop = shopById(shopId);
    return shop.items.find(i => i.id === itemId);
  }

  function inCartQty(shopId,itemId){
    return cart.get(`${shopId}:${itemId}`)?.qty ?? 0;
  }

  function add(shopId,itemId){
    const item = itemById(shopId,itemId);
    const key = `${shopId}:${itemId}`;
    const cur = cart.get(key) || { shopId, itemId, qty: 0 };
    const max = (item.stock ?? 999);
    if (cur.qty >= max) return;
    cur.qty += 1;
    cart.set(key, cur);
    render();
  }

  function remove(shopId,itemId){
    const key = `${shopId}:${itemId}`;
    const cur = cart.get(key);
    if (!cur) return;
    cur.qty -= 1;
    if (cur.qty <= 0) cart.delete(key);
    render();
  }

  function clearCart(){
    cart.clear();
    render();
  }

  function totalGp(){
    let total = 0;
    for(const entry of cart.values()){
      const item = itemById(entry.shopId, entry.itemId);
      total += (Number(item.price_gp) * entry.qty);
    }
    return to2(total);
  }

  function checkoutText(){
    const lines = [];
    for(const entry of cart.values()){
      const shop = shopById(entry.shopId);
      const item = itemById(entry.shopId, entry.itemId);
      lines.push(`BUY: ${item.name} | Qty: ${entry.qty} | Price: ${formatCoins(item.price_gp, item.stock)} | Shop: ${shop.name}`);
    }
    lines.push(`TOTAL: ${formatCoins(totalGp())}`);
    return lines.join("\n");
  }

  async function copyCheckout(){
    const text = checkoutText();
    try{
      await navigator.clipboard.writeText(text);
      alert("Checkout copied to clipboard.");
    }catch{
      prompt("Copy this:", text);
    }
  }

  function rebuildCategories(){
    const shop = shopById(activeShopId);
    if (!shop || shop.kind === "builder") {
      categoryEl.innerHTML = `<option value="">All categories</option>`;
      categoryTerm = "";
      categoryEl.value = "";
      return;
    }

    const cats = Array.from(
      new Set((shop.items || []).map(i => i.category).filter(Boolean))
    ).sort((a,b) => a.localeCompare(b));

    categoryEl.innerHTML =
      `<option value="">All categories</option>` +
      cats.map(c => `<option value="${c}">${c}</option>`).join("");

    categoryTerm = "";
    categoryEl.value = "";
  }

  function renderTabs(){
    tabsEl.innerHTML = "";

    const shops = DATA.shops.filter(s => {
      if (!shopSearchTerm) return true;
      return (s.name || "").toLowerCase().includes(shopSearchTerm) ||
             (s.tagline || "").toLowerCase().includes(shopSearchTerm);
    });

    shops.forEach(shop => {
      const btn = document.createElement("div");
      btn.className = "shopBtn" + (shop.id === activeShopId ? " active" : "");
      btn.onclick = () => {
        activeShopId = shop.id;
        rebuildCategories();
        render();
      };

      const icon = document.createElement("div");
      icon.className = "shopIcon";
      icon.textContent = shop.icon_emoji || "üè™";

      const meta = document.createElement("div");
      meta.innerHTML = `<div class="shopName">${shop.name}</div><div class="shopHint">${shop.tagline ?? ""}</div>`;

      btn.appendChild(icon);
      btn.appendChild(meta);
      tabsEl.appendChild(btn);
    });

    const active = shopById(activeShopId);
    shopTitleEl.textContent = active ? `‚Äî ${active.name}` : "";
  }

  function renderShopDropdown(){
    // Used ONLY in builder-mode, but safe to keep updated always.
    shopDropdownEl.innerHTML = DATA.shops.map(s => {
      const sel = (s.id === activeShopId) ? "selected" : "";
      return `<option value="${s.id}" ${sel}>${s.name}</option>`;
    }).join("");

    const active = shopById(activeShopId);
    quickShopHintEl.textContent = active?.tagline ? `‚Äî ${active.tagline}` : "";
  }

  // ======= BUILDER SHOP (GUNSMITH) =======
  const gunBuild = {
    baseId: null,
    mods: new Map() // modId -> { catId, mod }
  };

  function gp(n){ return Number(n || 0); }

  function builderSlotLimit(shop){
    const base = shop.builder.baseModels.find(x => x.id === gunBuild.baseId);
    return base ? Number(base.slots) : 0;
  }

  function builderSlotsUsed(){ return gunBuild.mods.size; }

  function builderTotalGp(shop){
    const b = shop.builder;
    let total = 0;
    const base = b.baseModels.find(x => x.id === gunBuild.baseId);
    if (base) total += gp(base.price_gp);
    for (const entry of gunBuild.mods.values()) total += gp(entry.mod.price_gp);
    return to2(total);
  }

  function builderCounts(){
    let extraAttack = 0, aoe = 0;
    for (const entry of gunBuild.mods.values()){
      const tags = entry.mod.tags || [];
      if (tags.includes("extra_attack")) extraAttack++;
      if (tags.includes("aoe")) aoe++;
    }
    return { extraAttack, aoe };
  }

  function builderWarnings(shop){
    const b = shop.builder;
    const issues = [];

    const base = b.baseModels.find(x => x.id === gunBuild.baseId);
    if (!base) issues.push("Select a base gun model.");

    const slotsUsed = builderSlotsUsed();
    const slotLimit = builderSlotLimit(shop);
    if (base && slotsUsed > slotLimit) issues.push(`Too many mods: ${slotsUsed}/${slotLimit} slots.`);

    // Soft reminders
    let controlCount = 0;
    let critCount = 0;
    for (const entry of gunBuild.mods.values()){
      const tags = entry.mod.tags || [];
      if (tags.includes("control")) controlCount++;
      if (tags.includes("crit")) critCount++;
    }
    if (critCount > 1) issues.push("Reminder: Only one crit-triggered mod effect may activate per turn (choose one).");
    if (controlCount > 1) issues.push("Reminder: Target can suffer only one movement/reaction-denying effect per round from mods.");

    // Hard rules
    const counts = builderCounts();
    if (counts.extraAttack > b.rules.maxExtraAttackMods) issues.push("Rule broken: Only one mod may grant additional attacks.");
    if (counts.aoe > b.rules.maxAoeMods) issues.push("Rule broken: Only one AoE mod may be installed.");

    return issues;
  }

function builderCheckoutText(shop){
  const b = shop.builder;
  const base = b.baseModels.find(x => x.id === gunBuild.baseId);

  const byCat = {};
  for (const entry of gunBuild.mods.values()){
    (byCat[entry.catId] ||= []).push(entry.mod);
  }

  const catLabel = (catId) => {
    const c = b.modCategories.find(x => x.id === catId);
    return c ? c.name : catId;
  };

  const lines = [];
  lines.push(`SHOP: ${shop.name}`);
  lines.push(``);

  if (base){
    lines.push(`GUN: ${base.name} (${base.rarity})`);
    lines.push(`SLOTS: ${gunBuild.mods.size}/${base.slots}`);
    lines.push(`BASE PRICE: ${formatCoins(base.price_gp)}`);
  } else {
    lines.push(`GUN: (no base selected)`);
    lines.push(`SLOTS: ${gunBuild.mods.size}/0`);
    lines.push(`BASE PRICE: 0 gp`);
  }

  lines.push(``);

  // Print mods in category order for readability
  lines.push(`MODS:`);
  for (const cat of b.modCategories){
    const mods = byCat[cat.id] || [];
    if (!mods.length) continue;
    lines.push(`- ${cat.name}:`);
    for (const m of mods){
      lines.push(`  ‚Ä¢ ${m.name} ‚Äî ${formatCoins(m.price_gp)} ‚Äî ${m.desc}`);
    }
  }

  if (gunBuild.mods.size === 0) lines.push(`(none)`);

  lines.push(``);
  lines.push(`TOTAL: ${formatCoins(builderTotalGp(shop))}`);
  lines.push(`INSTALL: Installing/removing a mod takes 1 hour and appropriate tools.`);
  lines.push(`RULES: Max 1 extra-attack mod; Max 1 AoE mod; Choose only 1 crit effect per turn; Only 1 control effect per round.`);

  return lines.join("\n");
}

  window.__builderToggleSection = (id) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.toggle("open");
  };

  window.__builderAdd = (catId, modId) => {
    const shop = shopById(activeShopId);
    const cat = shop.builder.modCategories.find(c => c.id === catId);
    const mod = cat.mods.find(m => m.id === modId);

    if (!gunBuild.baseId){
      alert("Select a base gun model first.");
      return;
    }

    if (gunBuild.mods.has(modId)) return; // no duplicates

    // one-per-category if required
    if (cat.limitOneInstalled){
      for (const [k,v] of gunBuild.mods.entries()){
        if (v.catId === catId) gunBuild.mods.delete(k);
      }
    }

    // slot limit
    if (gunBuild.mods.size >= builderSlotLimit(shop)){
      alert("No slots available for another mod.");
      return;
    }

    // hard rules
    const counts = builderCounts();
    if ((mod.tags || []).includes("extra_attack") && counts.extraAttack >= shop.builder.rules.maxExtraAttackMods){
      alert("Rule: Only one mod may grant additional attacks.");
      return;
    }
    if ((mod.tags || []).includes("aoe") && counts.aoe >= shop.builder.rules.maxAoeMods){
      alert("Rule: Only one AoE (cone/line/area) mod may be installed.");
      return;
    }

    gunBuild.mods.set(modId, { catId, mod });
    render();
  };

  window.__builderRemove = (modId) => {
    gunBuild.mods.delete(modId);
    render();
  };

  window.__builderCopy = async () => {
    const shop = shopById(activeShopId);
    const text = builderCheckoutText(shop);
    try{
      await navigator.clipboard.writeText(text);
      alert("Build checkout copied.");
    }catch{
      prompt("Copy this:", text);
    }
  };

  window.__builderReset = () => {
    gunBuild.baseId = null;
    gunBuild.mods.clear();
    render();
  };

function builderSummaryHtml(shop){
  const b = shop.builder;
  const base = b.baseModels.find(x => x.id === gunBuild.baseId);

  // group selected mods by category
  const picked = {};
  for (const entry of gunBuild.mods.values()){
    (picked[entry.catId] ||= []).push(entry.mod);
  }

  // order in the same order as categories list
  const selectedLines = [];
  for (const cat of b.modCategories){
    const mods = picked[cat.id] || [];
    if (!mods.length) continue;
    for (const m of mods){
      selectedLines.push(`${cat.name}: ${m.name}`);
    }
  }

  const summaryName = base ? `${base.name}` : `(Select a base model)`;
  const slotsText = base ? `${gunBuild.mods.size}/${base.slots}` : `${gunBuild.mods.size}/0`;
  const totalText = formatCoins(builderTotalGp(shop));

  const blocks = [];
  blocks.push(`GUN: ${summaryName}`);
  if (base) blocks.push(`RARITY: ${base.rarity}`);
  blocks.push(`SLOTS: ${slotsText}`);
  blocks.push(``);

  if (selectedLines.length){
    blocks.push(`ATTACHMENTS:`);
    for (const s of selectedLines) blocks.push(`- ${s}`);
  } else {
    blocks.push(`ATTACHMENTS: (none)`);
  }

  blocks.push(``);
  blocks.push(`TOTAL: ${totalText}`);
  blocks.push(`INSTALL: 1 hour to install/remove (no swapping in combat).`);
  blocks.push(`RULES: Max 1 extra-attack mod ¬∑ Max 1 AoE mod ¬∑ Only 1 crit effect per turn ¬∑ Only 1 control effect per round`);

  return `
    <div class="summaryBox">
      <div class="summaryTitle">
        <span>Weapon Summary</span>
        <span class="badge">${totalText}</span>
      </div>

      <div class="summaryCols">
        <div class="summaryCard">
          <h3>At a glance</h3>
          <div class="summaryLine"><span>Base</span><span class="summaryStrong">${base ? `${base.name}` : "‚Äî"}</span></div>
          <div class="summaryLine"><span>Rarity</span><span class="summaryStrong">${base ? base.rarity : "‚Äî"}</span></div>
          <div class="summaryLine"><span>Slots used</span><span class="summaryStrong">${slotsText}</span></div>
          <div class="summaryLine"><span>Total</span><span class="summaryStrong">${totalText}</span></div>
        </div>

        <div class="summaryCard">
          <h3>DM checkout text</h3>
          <div class="preBlock">${escapeHtml(builderCheckoutText(shop))}</div>
        </div>
      </div>
    </div>
  `;
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}


  function renderBuilder(shop){
    const b = shop.builder;

    // Base dropdown
    const baseOptions = b.baseModels.map(m => {
      const selected = (m.id === gunBuild.baseId) ? "selected" : "";
      return `<option value="${m.id}" ${selected}>${m.name} ‚Äî ${m.slots} slots ‚Äî ${m.price_gp} gp</option>`;
    }).join("");

    const used = builderSlotsUsed();
    const limit = builderSlotLimit(shop);
    const total = builderTotalGp(shop);

    const issues = builderWarnings(shop);
    const issuesHtml = issues.length
      ? `<div class="warnBox"><div class="title" style="font-size:13px">Build Notes</div><div class="empty" style="margin-top:6px">${issues.map(x=>`‚Ä¢ ${x}`).join("<br>")}</div></div>`
      : `<div class="okBox"><div class="title" style="font-size:13px">Build OK</div><div class="empty" style="margin-top:6px">Slot limits and hard restrictions satisfied.</div></div>`;

    // Sections
    const sectionsHtml = b.modCategories.map((cat, idx) => {
      const sectionId = `sec_${cat.id}`;
      const openByDefault = idx === 0 ? "open" : "";
      const selectedInCat = Array.from(gunBuild.mods.values()).some(x => x.catId === cat.id);

      const modCards = cat.mods.map(mod => {
        const isSelected = gunBuild.mods.has(mod.id);

        const counts = builderCounts();
        const wouldBreakSlots = (!isSelected && gunBuild.baseId && used >= limit);
        const wouldBreakCat = (!isSelected && cat.limitOneInstalled && selectedInCat);
        const wouldBreakExtraAttack = (!isSelected && (mod.tags||[]).includes("extra_attack") && counts.extraAttack >= b.rules.maxExtraAttackMods);
        const wouldBreakAoe = (!isSelected && (mod.tags||[]).includes("aoe") && counts.aoe >= b.rules.maxAoeMods);

        const disabled = (!gunBuild.baseId) || wouldBreakSlots || wouldBreakCat || wouldBreakExtraAttack || wouldBreakAoe;

        const tagBadges = (mod.tags || []).map(t => `<span class="badge">${t}</span>`).join("");

        return `
          <div class="modCard ${disabled && !isSelected ? "disabled" : ""}">
            <div>
              <div class="modName">${mod.name}</div>
              <div class="modDesc">${mod.desc}</div>
              ${tagBadges ? `<div class="tagRow">${tagBadges}</div>` : ""}
            </div>

            <div style="text-align:right; min-width:150px">
              <div class="price">${formatCoins(mod.price_gp)}</div>
              <div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end; align-items:center;">
                <button class="miniBtn ${isSelected ? "on" : ""}" ${isSelected ? "" : "disabled"} onclick="__builderRemove('${mod.id}')">Remove</button>
                <button class="miniBtn ${isSelected ? "on" : ""}" ${disabled ? "disabled" : ""} onclick="__builderAdd('${cat.id}','${mod.id}')">${isSelected ? "Selected" : "Add"}</button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      return `
        <div class="section ${openByDefault}" id="${sectionId}">
          <div class="sectionHead" onclick="__builderToggleSection('${sectionId}')">
            <div class="sectionTitle">${cat.name} ${cat.limitOneInstalled ? "¬∑ (MAX 1)" : ""}</div>
            <div class="caret">‚ñæ</div>
          </div>
          <div class="sectionBody">
            <div class="modGrid">${modCards}</div>
          </div>
        </div>
      `;
    }).join("");

    itemsEl.innerHTML = `
      <div class="builderTop">
        <div class="builderTopGrid">
          <div>
            <div class="title">üîß Gunsmith Builder <span class="badge">Slots define power</span></div>
            <div class="meta">Choose a base gun, then add mods (1 slot each). No swapping in combat. 1 hour to install/remove.</div>
          </div>

          <div class="builderControls">
            <select id="baseSelect" class="tool" style="min-width: 320px">
              <option value="">Select base gun model‚Ä¶</option>
              ${baseOptions}
            </select>
            <button class="toolBtn ok" onclick="__builderCopy()">Copy Build Checkout</button>
            <button class="toolBtn danger" onclick="__builderReset()">Reset</button>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; margin-top:10px">
          <div class="empty">Slots: <strong>${used}/${limit}</strong></div>
          <div class="empty">Total: <strong>${formatCoins(total)}</strong></div>
        </div>

        ${issuesHtml}
      </div>

      ${sectionsHtml}
	  ${builderSummaryHtml(shop)}
    `;

    document.getElementById("baseSelect").addEventListener("change", (e) => {
      gunBuild.baseId = e.target.value || null;

      // If slots shrink, auto-remove extras (last added)
      const lim = builderSlotLimit(shop);
      while (gunBuild.mods.size > lim){
        const lastKey = Array.from(gunBuild.mods.keys()).pop();
        gunBuild.mods.delete(lastKey);
      }
      render();
    });
  }

  // ======= ITEMS RENDER =======
  function renderItems(){
    const shop = shopById(activeShopId);
    itemsEl.innerHTML = "";
    if (!shop) return;

    if (shop.kind === "builder"){
      renderBuilder(shop);
      return;
    }

    let items = (shop.items || []).slice();

    if (categoryTerm) items = items.filter(i => (i.category || "") === categoryTerm);

    if (itemSearchTerm){
      items = items.filter(i => {
        const hay = `${i.name} ${i.desc ?? ""} ${i.category ?? ""}`.toLowerCase();
        return hay.includes(itemSearchTerm);
      });
    }

    items.sort((a,b) => (Number(a.price_gp) - Number(b.price_gp)) * sortDir);

    items.forEach(item => {
      const row = document.createElement("div");
      row.className = "itemRow";

      let stockBadge = `<span class="badge good">‚úÖ In stock</span>`;
      if (item.stock === 0) stockBadge = `<span class="badge bad">‚ùå Out of stock</span>`;
      else if (item.stock != null && item.stock !== 999 && item.stock < 999) stockBadge = `<span class="badge warn">‚ö†Ô∏è Limited (${item.stock})</span>`;

      const rarityBadge = item.rarity ? `<span class="badge">${item.rarity}</span>` : "";
      const catBadge = item.category ? `<span class="badge">${item.category}</span>` : "";

      const left = document.createElement("div");
      left.innerHTML = `
        <div class="title">${item.name} ${rarityBadge} ${catBadge}</div>
        ${item.desc ? `<div class="meta">${item.desc}</div>` : ""}
        <div class="meta small">${stockBadge}</div>
      `;

      const right = document.createElement("div");
      right.className = "rightCol";
      right.innerHTML = `<div class="price">${formatCoins(item.price_gp, item.stock)}</div>`;

      const controls = document.createElement("div");
      controls.className = "controls";

      const minus = document.createElement("button");
      minus.className = "small";
      minus.textContent = "‚àí";
      minus.disabled = inCartQty(shop.id, item.id) === 0;
      minus.onclick = () => remove(shop.id, item.id);

      const qty = document.createElement("div");
      qty.className = "qty";
      qty.textContent = inCartQty(shop.id, item.id);

      const plus = document.createElement("button");
      plus.className = "small";
      plus.textContent = "+";
      const max = (item.stock ?? 999);
      plus.disabled = (item.stock === 0) || (inCartQty(shop.id, item.id) >= max);
      plus.onclick = () => add(shop.id, item.id);

      controls.appendChild(minus);
      controls.appendChild(qty);
      controls.appendChild(plus);

      right.appendChild(controls);

      row.appendChild(left);
      row.appendChild(right);
      itemsEl.appendChild(row);
    });
  }

  // ======= CART RENDER =======
  function renderCart(){
    const activeShop = shopById(activeShopId);

    if (activeShop?.kind === "builder"){
      cartEl.innerHTML = `
        <div class="cartline">
          <div>
            <strong>${activeShop.name}</strong>
            <div class="empty">Build guns & attachments (slot-based)</div>
          </div>
          <div style="text-align:right">
            <div class="total">${formatCoins(builderTotalGp(activeShop))}</div>
            <div class="empty">Slots: ${builderSlotsUsed()}/${builderSlotLimit(activeShop)}</div>
          </div>
        </div>

        <div class="footerBtns">
          <button class="ok" onclick="__builderCopy()">Copy Build Checkout</button>
          <button class="danger" onclick="__builderReset()">Reset Build</button>
        </div>

        <div class="cartline">
          <div class="empty">
            Tip: Pick a base first. Then open a section (Barrel/Frame/etc) and click <strong>Add</strong>.
            Category headings keep the list tidy.
          </div>
        </div>
      `;
      return;
    }

    cartEl.innerHTML = "";
    if(cart.size === 0){
      cartEl.innerHTML = `<div class="empty">Your cart is empty.</div>`;
      return;
    }

    for(const entry of cart.values()){
      const shop = shopById(entry.shopId);
      const item = itemById(entry.shopId, entry.itemId);

      const line = document.createElement("div");
      line.className = "cartline";
      line.innerHTML = `
        <div>
          <strong>${item.name}</strong>
          <div class="empty">${shop.name}</div>
        </div>
        <div style="text-align:right">
          <div>${entry.qty} √ó ${formatCoins(item.price_gp, item.stock)}</div>
          <div class="empty">= ${formatCoins(Number(item.price_gp) * entry.qty)}</div>
        </div>
      `;
      cartEl.appendChild(line);
    }

    const total = document.createElement("div");
    total.innerHTML = `<div class="row"><span class="empty">Total</span><span class="total">${formatCoins(totalGp())}</span></div>`;
    cartEl.appendChild(total);

    const btns = document.createElement("div");
    btns.className = "footerBtns";

    const copyBtn = document.createElement("button");
    copyBtn.className = "ok";
    copyBtn.textContent = "Copy Checkout";
    copyBtn.onclick = copyCheckout;

    const clearBtn = document.createElement("button");
    clearBtn.className = "danger";
    clearBtn.textContent = "Clear Cart";
    clearBtn.onclick = clearCart;

    const viewBtn = document.createElement("button");
    viewBtn.className = "ghost";
    viewBtn.textContent = "View Checkout Text";
    viewBtn.onclick = () => alert(checkoutText());

    btns.appendChild(copyBtn);
    btns.appendChild(viewBtn);
    btns.appendChild(clearBtn);

    cartEl.appendChild(btns);
  }

  // ======= MAIN RENDER =======
  function render(){
    const shop = shopById(activeShopId);
    const isBuilder = shop?.kind === "builder";

    // Toggle builder mode layout + controls
    document.body.classList.toggle("builder-mode", !!isBuilder);

    // Normal toolbar hidden for builder
    toolbarEl.style.display = isBuilder ? "none" : "flex";

    // Update shop title + lists
    renderTabs();
    renderShopDropdown();
    renderItems();
    renderCart();
  }

  // ======= INIT =======
  async function init(){
    const res = await fetch("./inventory.json", { cache: "no-store" });
    DATA = await res.json();

    shopSearchEl.addEventListener("input", (e) => {
      shopSearchTerm = e.target.value.toLowerCase();
      renderTabs();
    });

    itemSearchEl.addEventListener("input", (e) => {
      itemSearchTerm = e.target.value.toLowerCase();
      renderItems();
    });

    categoryEl.addEventListener("change", (e) => {
      categoryTerm = e.target.value;
      renderItems();
    });

    sortBtnEl.addEventListener("click", () => {
      sortDir *= -1;
      sortBtnEl.textContent = `Sort: Price ${sortDir === 1 ? "‚Üë" : "‚Üì"}`;
      renderItems();
    });

    shopDropdownEl.addEventListener("change", (e) => {
      activeShopId = e.target.value;
      rebuildCategories();
      render();
    });

    activeShopId = DATA.shops[0]?.id ?? null;
    rebuildCategories();

    // Set header shop title once now
    const active = shopById(activeShopId);
    shopTitleEl.textContent = active ? `‚Äî ${active.name}` : "";

    render();
  }

  init().catch(err => {
    document.body.innerHTML = `<div style="padding:16px;color:#fff">
      <h2>Failed to load inventory.json</h2>
      <pre>${String(err)}</pre>
    </div>`;
  });
</script>
</body>
</html>
